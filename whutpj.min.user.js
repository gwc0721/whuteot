// ==UserScript==
// @name        武理工教务系统自动批量教学评价
// @namespace   whuteot
// @description 武汉理工大学 学分制教务管理信息系统 自动教学评价 全选A 跳过问卷调查
// @author      Anonymous
// @include     http://202.114.90.180/EOT/*
// @run-at      document-end
// @version     2.1
// @grant       unsafeWindow
// @grant       GM_addStyle
// @grant       GM_getValue
// @grant       GM_setValue
// @grant       GM_deleteValue
// @grant       GM_listValues
// @license     MIT/Expat License
// ==/UserScript==
!function(){function t(t){var e=document.createElement("script");e.type="text/javascript",e.textContent="("+t.toString()+")();",document.body.appendChild(e)}function e(){function t(e,o){this.options=$.extend({},t.defaults,o),this.pjrwdm=e,this.pjzb_storage=[],this.pjrw_count=0,this.pjzb_check_count=0,this.error_locked=!1}t.defaults={timeout:3e3,zb_check_cycle:1e3,max_zb_save_attempts:3,max_zb_check_attempts:10,max_pjrw_save_attempts:3,success:function(){},fail:function(){},error:function(){}},t.zb={A:"9.25",B:"8",C:"6.75",D:"5",E:"3"},t.prototype.save_zb=function(e,o){o=o?o.toUpperCase():"A",$.ajax({url:"/EOT/rwpjzbSave.do",type:"POST",global:!1,context:this,timeout:this.options.timeout,data:{pjrwdm:this.pjrwdm,pjzbdm:e,zbda:o,pjfz:t.zb[o]},beforeSend:function(){var t=this.pjzb_storage[e]?this.pjzb_storage[e].count+1:1;this.pjzb_storage[e]={count:t}},success:function(){this.pjzb_storage[e]={value:o,count:this.pjzb_storage[e].count}},error:function(t,i,s){return this.pjzb_storage[e].count<=this.options.max_zb_save_attempts?this.save_zb(e,o):void(this.options.error&&!this.error_locked&&this.options.error("zb_save_limit_exceeded",{pjrwdm:this.pjrwdm,jqXHR:t,textStatus:i,errorThrown:s}))}})},t.prototype.save_pjrw=function(t){$.ajax({url:"/EOT/rwpjSave.do",type:"POST",dataType:"json",cache:!1,global:!1,context:this,timeout:this.options.timeout,data:{pjrwdm:this.pjrwdm,cpdxdm:"",zb1:this.pjzb_storage[1].value,zb2:this.pjzb_storage[2].value,zb3:this.pjzb_storage[3].value,zb4:this.pjzb_storage[4].value,zb5:this.pjzb_storage[5].value,zb6:this.pjzb_storage[6].value,zb7:this.pjzb_storage[7].value,zb8:this.pjzb_storage[8].value,zb9:this.pjzb_storage[9].value,zb10:this.pjzb_storage[10].value,zbtmdm:9,py:"",wjwtdm:9,xzwdt:"",xzwdttm:9,xzwdtxx:"G",wdttm:10,wdt:""},beforeSend:function(){this.pjrw_count++},success:function(e){"200"==e.statusCode?this.options.success&&this.options.success(this.pjrwdm,e):this.options.fail&&this.options.fail(this.pjrwdm,e),t&&t(this.pjrwdm,e)},error:function(e,o,i){return this.pjrw_count<=this.options.max_pjrw_save_attempts?this.save_pjrw(t):void(this.options.error&&!this.error_locked&&this.options.error("pjrw_save_limit_exceeded",{pjrwdm:this.pjrwdm,jqXHR:e,textStatus:o,errorThrown:i}))}})},t.prototype.check_if_all_zb_saved=function(t){for(var e=!0,o=1;10>=o;++o)if(!this.pjzb_storage[o]||!this.pjzb_storage[o].value){e=!1;break}this.pjzb_check_count++,e?this.save_pjrw(t):this.pjzb_check_count<=this.options.max_zb_check_attempts?setTimeout(this.check_if_all_zb_saved.bind(this,t),this.options.zb_check_cycle):this.options.error&&!this.error_locked&&this.options.error("zb_check_limit_exceeded",{pjrwdm:this.pjrwdm})},t.prototype.submit=function(t){for(var e=1;10>=e;++e)this.save_zb(e);this.check_if_all_zb_saved(t)};var e={};e.lessons=[],e.lessonsTab=null,e.rwpjOffset=0,e.init=function(){e.showStartButton()},e.showStartButton=function(){$("<a href='#' class='btn-startpj'>开始评教</a>").css({"z-index":1e4,position:"absolute",top:"55px",right:"24px",padding:"0 8px",color:"#ffffff",background:"rgba(0,0,0,.6)","font-family":'"Segoe UI", "Lucida Grande", Helvetica, Arial, "Microsoft YaHei Light", "Microsoft YaHei", FreeSans, Arimo, "Droid Sans","wenquanyi micro hei","Hiragino Sans GB", "Hiragino Sans GB W3", sans-serif',"font-size":"16px"}).click(function(){e.showLessonsListTab(),$(this).remove()}).appendTo("body");var t="";t+='<style type="text/css">',t+=".btn-startpj { animation: pulse 1.2s infinite; }",t+="@keyframes pulse {",t+="  0% { outline:rgba(221,107,85,1) solid 2px; box-shadow:rgba(221,107,85,1) 0px 0px 0px; outline-offset:0; background:rgba(0,0,0,.6); }",t+="  10% { background:rgba(221,107,85,.6); }",t+="  80% { background:rgba(0,0,0,.6); }",t+="  100% { outline:rgba(221,107,85,0) solid 2px; box-shadow:rgba(221,107,85,0) 0px 0px 12px; outline-offset:12px; }",t+="}",t+="</style>",$("head").append(t)},e.registerJGrowl=function(){!function(t){var e=function(){return!1===t.support.boxModel&&t.support.objectAll&&t.support.leadingWhitespace}();t.jGrowl=function(e,o){0==t("#jGrowl").size()&&t('<div id="jGrowl"></div>').addClass(o&&o.position?o.position:t.jGrowl.defaults.position).appendTo("body"),t("#jGrowl").jGrowl(e,o)},t.fn.jGrowl=function(e,o){if(t.isFunction(this.each)){var i=arguments;return this.each(function(){void 0==t(this).data("jGrowl.instance")&&(t(this).data("jGrowl.instance",t.extend(new t.fn.jGrowl,{notifications:[],element:null,interval:null})),t(this).data("jGrowl.instance").startup(this)),t.isFunction(t(this).data("jGrowl.instance")[e])?t(this).data("jGrowl.instance")[e].apply(t(this).data("jGrowl.instance"),t.makeArray(i).slice(1)):t(this).data("jGrowl.instance").create(e,o)})}},t.extend(t.fn.jGrowl.prototype,{defaults:{pool:0,header:"",group:"",sticky:!1,position:"top-right",glue:"after",theme:"default",themeState:"highlight",corners:"10px",check:250,life:3e3,closeDuration:"normal",openDuration:"normal",easing:"swing",closer:!0,closeTemplate:"&times;",closerTemplate:"<div>[ close all ]</div>",log:function(){},beforeOpen:function(){},afterOpen:function(){},open:function(){},beforeClose:function(){},close:function(){},animateOpen:{opacity:"show"},animateClose:{opacity:"hide"}},notifications:[],element:null,interval:null,create:function(e,o){var o=t.extend({},this.defaults,o);void 0!==o.speed&&(o.openDuration=o.speed,o.closeDuration=o.speed),this.notifications.push({message:e,options:o}),o.log.apply(this.element,[this.element,e,o])},render:function(e){var o=this,i=e.message,s=e.options;s.themeState=""==s.themeState?"":"ui-state-"+s.themeState;var e=t("<div/>").addClass("jGrowl-notification "+s.themeState+" ui-corner-all"+(void 0!=s.group&&""!=s.group?" "+s.group:"")).append(t("<div/>").addClass("jGrowl-close").html(s.closeTemplate)).append(t("<div/>").addClass("jGrowl-header").html(s.header)).append(t("<div/>").addClass("jGrowl-message").html(i)).data("jGrowl",s).addClass(s.theme).children("div.jGrowl-close").bind("click.jGrowl",function(){t(this).parent().trigger("jGrowl.beforeClose")}).parent();t(e).bind("mouseover.jGrowl",function(){t("div.jGrowl-notification",o.element).data("jGrowl.pause",!0)}).bind("mouseout.jGrowl",function(){t("div.jGrowl-notification",o.element).data("jGrowl.pause",!1)}).bind("jGrowl.beforeOpen",function(){s.beforeOpen.apply(e,[e,i,s,o.element])!==!1&&t(this).trigger("jGrowl.open")}).bind("jGrowl.open",function(){s.open.apply(e,[e,i,s,o.element])!==!1&&("after"==s.glue?t("div.jGrowl-notification:last",o.element).after(e):t("div.jGrowl-notification:first",o.element).before(e),t(this).animate(s.animateOpen,s.openDuration,s.easing,function(){t.support.opacity===!1&&this.style.removeAttribute("filter"),null!==t(this).data("jGrowl")&&(t(this).data("jGrowl").created=new Date),t(this).trigger("jGrowl.afterOpen")}))}).bind("jGrowl.afterOpen",function(){s.afterOpen.apply(e,[e,i,s,o.element])}).bind("jGrowl.beforeClose",function(){s.beforeClose.apply(e,[e,i,s,o.element])!==!1&&t(this).trigger("jGrowl.close")}).bind("jGrowl.close",function(){t(this).data("jGrowl.pause",!0),t(this).animate(s.animateClose,s.closeDuration,s.easing,function(){t.isFunction(s.close)?s.close.apply(e,[e,i,s,o.element])!==!1&&t(this).remove():t(this).remove()})}).trigger("jGrowl.beforeOpen"),""!=s.corners&&void 0!=t.fn.corner&&t(e).corner(s.corners),t("div.jGrowl-notification:parent",o.element).size()>1&&0==t("div.jGrowl-closer",o.element).size()&&this.defaults.closer!==!1&&t(this.defaults.closerTemplate).addClass("jGrowl-closer "+this.defaults.themeState+" ui-corner-all").addClass(this.defaults.theme).appendTo(o.element).animate(this.defaults.animateOpen,this.defaults.speed,this.defaults.easing).bind("click.jGrowl",function(){t(this).siblings().trigger("jGrowl.beforeClose"),t.isFunction(o.defaults.closer)&&o.defaults.closer.apply(t(this).parent()[0],[t(this).parent()[0]])})},update:function(){t(this.element).find("div.jGrowl-notification:parent").each(function(){void 0!=t(this).data("jGrowl")&&void 0!==t(this).data("jGrowl").created&&t(this).data("jGrowl").created.getTime()+parseInt(t(this).data("jGrowl").life)<(new Date).getTime()&&t(this).data("jGrowl").sticky!==!0&&(void 0==t(this).data("jGrowl.pause")||t(this).data("jGrowl.pause")!==!0)&&t(this).trigger("jGrowl.beforeClose")}),this.notifications.length>0&&(0==this.defaults.pool||t(this.element).find("div.jGrowl-notification:parent").size()<this.defaults.pool)&&this.render(this.notifications.shift()),2>t(this.element).find("div.jGrowl-notification:parent").size()&&t(this.element).find("div.jGrowl-closer").animate(this.defaults.animateClose,this.defaults.speed,this.defaults.easing,function(){t(this).remove()})},startup:function(o){this.element=t(o).addClass("jGrowl").append('<div class="jGrowl-notification"></div>'),this.interval=setInterval(function(){t(o).data("jGrowl.instance").update()},parseInt(this.defaults.check)),e&&t(this.element).addClass("ie6")},shutdown:function(){t(this.element).removeClass("jGrowl").find("div.jGrowl-notification").trigger("jGrowl.close").parent().empty(),clearInterval(this.interval)},close:function(){t(this.element).find("div.jGrowl-notification").each(function(){t(this).trigger("jGrowl.beforeClose")})}}),t.jGrowl.defaults=t.fn.jGrowl.prototype.defaults}(jQuery),$("body").append("<div id='TOPLEFTMSG' class='jGrowl top-left'><style stype='text/css'>div.jGrowl{z-index:100010;color:#fff;font-size:12px}div.jGrowl a{color:#FF0}div.jGrowl a:hover{text-decoration:underline}div.ie6{position:absolute}div.ie6.top-right{right:auto;bottom:auto;left:expression((0-jGrowl.offsetWidth+(document.documentElement.clientWidth?document.documentElement.clientWidth:document.body.clientWidth)+(ignoreMe2=document.documentElement.scrollLeft?document.documentElement.scrollLeft:document.body.scrollLeft))+'px');top:expression((0+(ignoreMe=document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop))+'px')}div.ie6.top-left{left:expression((0+(ignoreMe2=document.documentElement.scrollLeft?document.documentElement.scrollLeft:document.body.scrollLeft))+'px');top:expression((0+(ignoreMe=document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop))+'px')}div.ie6.bottom-right{left:expression((0-jGrowl.offsetWidth+(document.documentElement.clientWidth?document.documentElement.clientWidth:document.body.clientWidth)+(ignoreMe2=document.documentElement.scrollLeft?document.documentElement.scrollLeft:document.body.scrollLeft))+'px');top:expression((0-jGrowl.offsetHeight+(document.documentElement.clientHeight?document.documentElement.clientHeight:document.body.clientHeight)+(ignoreMe=document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop))+'px')}div.ie6.bottom-left{left:expression((0+(ignoreMe2=document.documentElement.scrollLeft?document.documentElement.scrollLeft:document.body.scrollLeft))+'px');top:expression((0-jGrowl.offsetHeight+(document.documentElement.clientHeight?document.documentElement.clientHeight:document.body.clientHeight)+(ignoreMe=document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop))+'px')}div.ie6.center{left:expression((0+(ignoreMe2=document.documentElement.scrollLeft?document.documentElement.scrollLeft:document.body.scrollLeft))+'px');top:expression((0+(ignoreMe=document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop))+'px');width:100%}div.jGrowl{position:absolute}body > div.jGrowl{position:fixed}div.jGrowl.top-left{left:0;top:0}div.jGrowl.top-right{right:0;top:0}div.jGrowl.bottom-left{left:0;bottom:0}div.jGrowl.bottom-right{right:0;bottom:0}div.jGrowl.center{top:0;width:50%;left:25%}div.center div.jGrowl-notification,div.center div.jGrowl-closer{margin-left:auto;margin-right:auto}div.jGrowl div.jGrowl-notification,div.jGrowl div.jGrowl-closer{background-color:#000;opacity:.85;-ms-filter:\"progid:DXImageTransform.Microsoft.Alpha(Opacity=85)\";filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=85);zoom:1;width:235px;padding:10px;margin-top:5px;margin-bottom:5px;font-family:Tahoma,Arial,Helvetica,sans-serif;font-size:1em;text-align:left;display:none;-moz-border-radius:5px;-webkit-border-radius:5px;-o-border-radius:5px;border-radius:5px}div.jGrowl div.jGrowl-notification{min-height:40px}div.jGrowl div.jGrowl-notification,div.jGrowl div.jGrowl-closer{margin:10px}div.jGrowl div.jGrowl-notification div.jGrowl-header{font-weight:bold;font-size:.85em}div.jGrowl div.jGrowl-notification div.jGrowl-close{z-index:99;float:right;font-weight:bold;font-size:1em;cursor:pointer}div.jGrowl div.jGrowl-closer{padding-top:4px;padding-bottom:4px;cursor:pointer;font-size:.9em;font-weight:bold;text-align:center}@media print{div.jGrowl{display:none}}</style>"),$.jGrowl.defaults.life=1500,$.jGrowl.defaults.closerTemplate="<div>[ 关闭全部 ]</div>"},e.registerStyle=function(){var t="";t+='<style type="text/css">',t+=".text-muted { color: #777; }",t+=".text-primary { color: #428bca; }",t+="a.text-primary:hover { color: #3071a9; }",t+=".text-success { color: #2ECC40; }",t+="a.text-success:hover { color: #2b542c; }",t+=".text-info { color: #31708f; }",t+="a.text-info:hover { color: #245269; }",t+=".text-warning { color: #8a6d3b; }",t+="a.text-warning:hover { color: #66512c; }",t+=".text-danger { color: #FF4136; }",t+="a.text-danger:hover { color: #843534; }",t+=".bg-primary { color: #fff; background-color: #428bca; }",t+="a.bg-primary:hover { background-color: #3071a9; }",t+=".bg-success { background-color: #dff0d8; }",t+="a.bg-success:hover { background-color: #c1e2b3; }",t+=".bg-info { background-color: #d9edf7; }",t+="a.bg-info:hover { background-color: #afd9ee; }",t+=".bg-warning { background-color: #fcf8e3; }",t+="a.bg-warning:hover { background-color: #f7ecb5; }",t+=".bg-danger { background-color: #f2dede; }",t+="a.bg-danger:hover { background-color: #e4b9b9; }",t+=".text-green { color: #00ff00; }",t+='.jGrowl-message, .jGrowl-message p, .jGrowl-message b, .jGrowl-message span { font-size: 16px; font-family: "Segoe UI", "Lucida Grande", Helvetica, Arial, "Microsoft YaHei Light", "Microsoft YaHei", FreeSans, Arimo, "Droid Sans","wenquanyi micro hei","Hiragino Sans GB", "Hiragino Sans GB W3", sans-serif; }',t+="</style>",$("head").append(t)},e.showLessonsListTab=function(){this.registerJGrowl(),this.registerStyle(),$.jGrowl("正在读取课程评教列表..."),$("#sidebar > .accordion.dwz-accordion > .accordionContent a[rel='pjkcList']").click(),setTimeout(this.detectLessonsListTab.bind(this),400)},e.detectLessonsListTab=function(){return-1==navTab._indexTabId("pjkcList")||$("#progressBar").is(":visible")?setTimeout(this.detectLessonsListTab.bind(this),400):($.jGrowl("课程评教列表已加载完成"),this.collectLessons(),void this.startPJ())},e.collectLessons=function(){var t=navTab._indexTabId("pjkcList");this.lessonsTab=$(".navTab-panel > .page:nth-child("+(t+1)+")"),this.lessons=this.lessonsTab.find('table tr[target="sid_kcpjrwdm"]').map(function(){return{rel:$(this).attr("rel"),lesson:$(this).find("td:nth-child(1)").text(),teacher:$(this).find("td:nth-child(2)").text(),type:$(this).find("td:nth-child(3)").text(),starttime:$(this).find("td:nth-child(4)").text(),endtime:$(this).find("td:nth-child(5)").text(),status:$(this).find("td:nth-child(6)").text()}})},e.startPJ=function(){var e=this;if(this.rwpjOffset>=this.lessons.length)return navTab.closeTab("rwpj"),$("#sidebar > .accordion.dwz-accordion > .accordionContent a[rel='pjkcList']").click(),$.jGrowl("<p class='text-green'>评教完成!</p>",{sticky:!0});if("未评"!=this.lessons[this.rwpjOffset].status)return this.rwpjOffset++,this.startPJ();if(!this.dateCheck(this.lessons[this.rwpjOffset].starttime,this.lessons[this.rwpjOffset].endtime))return $("#TOPLEFTMSG").jGrowl("<p><b>"+this.lessons[this.rwpjOffset].lesson+"</b><br>不在评教时间内</p>",{sticky:!0}),this.rwpjOffset++,this.startPJ();var o=this.lessons[this.rwpjOffset],i=o.rel;$.jGrowl("正在评教: <b class='text-primary'>"+o.lesson+"</b>");var s=new t(i,{success:function(){e.rwpjOffset++,$.jGrowl("<p class='text-green'><b>"+o.lesson+"</b> 评教成功!</p>"),e.startPJ()},fail:function(t,i){console.error(o.lesson,t,i);var s=i&&i.message||"失败详情可在 Console 中查看";$("#TOPLEFTMSG").jGrowl("<p class='text-danger'><b>"+o.lesson+"</b><br>"+s+"</p>",{sticky:!0}),e.rwpjOffset++,e.startPJ()},error:function(t,i){console.error(o.lesson,t,i);var s=i&&i.message||"失败详情可在 Console 中查看";$("#TOPLEFTMSG").jGrowl("<p class='text-danger'><b>"+o.lesson+"</b><br>"+s+"</p>",{sticky:!0}),e.rwpjOffset++,e.startPJ()}});s.submit()},e.dateCheck=function(t,e,o,i){var s=(new Date).getTime(),n=this.strtodate(t,0,0,0,0).getTime(),r=this.strtodate(e,23,59,59,0).getTime();return i?r>=s:o?s>=n:s>=n&&r>=s},e.strtodate=function(t,e,o,i,s){var n=new Date,r=t.match(/(\d+)-(\d+)-(\d+)/),a=0|r[1],l=0|r[2],c=0|r[3];return e=e||0,o=o||0,i=i||0,s=s||0,n.setFullYear(a),n.setMonth(l?l-1:0),n.setDate(c),n.setHours(e),n.setMinutes(o),n.setSeconds(i),n.setMilliseconds(s),n},e.init()}return"undefined"==typeof unsafeWindow||window.$||!unsafeWindow.$?t(e):(window.$=unsafeWindow.$,void e())}();